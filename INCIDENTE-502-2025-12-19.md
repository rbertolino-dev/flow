# üö® Incidente: Erro 502 Bad Gateway - 19/12/2025

## üìã Resumo

**Data/Hora:** 19/12/2025 ~23:54 UTC  
**Status:** ‚úÖ RESOLVIDO  
**Dura√ß√£o:** ~10 minutos  
**Impacto:** Aplica√ß√£o inacess√≠vel via HTTPS (agilizeflow.com.br)

## üîç Causa Raiz

O erro 502 foi causado por **configura√ß√£o incorreta do Nginx**:

1. **Configura√ß√£o do dom√≠nio `agilizeflow.com.br`** estava apontando para `localhost:3001` (porta do Green)
2. **Apenas o container Blue estava rodando** na porta `3000` e saud√°vel
3. **N√£o havia nada rodando na porta 3001**, causando erro 502 quando o Nginx tentava fazer proxy

## üîß Corre√ß√£o Aplicada

### Problema Identificado:
```nginx
# ‚ùå ERRADO (antes)
proxy_pass http://localhost:3001;  # Porta 3001 n√£o tinha container rodando
```

### Corre√ß√£o:
```nginx
# ‚úÖ CORRETO (depois)
proxy_pass http://localhost:3000;  # Porta 3000 tem Blue rodando e saud√°vel
```

### Arquivos Corrigidos:
1. `/etc/nginx/sites-enabled/agilizeflow.com.br` - Corrigido para porta 3000
2. `/etc/nginx/sites-enabled/kanban-buzz` - J√° estava correto (porta 3000 para Blue)

## üìä Estado do Sistema no Momento do Erro

- ‚úÖ **Container Blue:** Rodando e saud√°vel na porta 3000
- ‚ùå **Container Green:** N√£o estava rodando
- ‚ùå **Nginx:** Configurado para porta 3001 (inexistente)

## üïê Timeline do Incidente

1. **~23:38 UTC** - √öltima modifica√ß√£o do arquivo nginx (`agilizeflow.com.br`)
2. **~23:54 UTC** - Container Blue iniciado (ap√≥s algum deploy/restart)
3. **~23:56 UTC** - Erro 502 detectado pelo usu√°rio
4. **~00:04 UTC** - Problema identificado e corrigido
5. **~00:05 UTC** - Aplica√ß√£o funcionando novamente

## üîç Investiga√ß√£o: Qual Deploy Causou?

### Poss√≠veis Causas:

1. **Deploy que alternou para Green mas Green n√£o subiu:**
   - Script de deploy pode ter alternado Nginx para Green
   - Mas container Green n√£o iniciou corretamente
   - Nginx ficou apontando para porta inexistente

2. **Modifica√ß√£o manual do Nginx:**
   - Arquivo foi modificado em 19/12/2025 23:38
   - Pode ter sido altera√ß√£o manual ou script que n√£o completou

3. **Rollback incompleto:**
   - Se houve rollback, pode ter revertido container mas n√£o Nginx

### Evid√™ncias:

- Container Blue iniciado em `2025-12-19T23:54:04Z`
- Arquivo nginx modificado em `2025-12-19 23:38:44`
- N√£o h√° logs de deploy recentes no diret√≥rio `scripts/*.log`
- Imagens Docker dispon√≠veis:
  - `kanban-buzz-95241-app-blue:latest` (87.4MB)
  - `kanban-buzz-95241-app-green:latest` (87.5MB)

## ‚úÖ Verifica√ß√£o P√≥s-Corre√ß√£o

```bash
# Health check funcionando
curl https://agilizeflow.com.br/health
# ‚úÖ Retorna: healthy

# Container Blue saud√°vel
docker ps | grep kanban-buzz-app-blue
# ‚úÖ Status: Up X minutes (healthy)

# Nginx configurado corretamente
grep "proxy_pass" /etc/nginx/sites-enabled/agilizeflow.com.br
# ‚úÖ localhost:3000
```

## üõ°Ô∏è Preven√ß√£o Futura

### Recomenda√ß√µes:

1. **Verificar configura√ß√£o do Nginx ap√≥s deploy:**
   ```bash
   # Adicionar ao script de deploy
   grep "proxy_pass" /etc/nginx/sites-enabled/agilizeflow.com.br | grep -q "localhost:3000\|localhost:3001"
   ```

2. **Garantir que script de deploy sempre atualiza Nginx corretamente:**
   - Script deve verificar qual vers√£o est√° rodando antes de alternar
   - N√£o deve alternar se vers√£o de destino n√£o estiver saud√°vel

3. **Monitoramento:**
   - Adicionar alerta para erro 502 no Nginx
   - Verificar health check de ambas vers√µes antes de alternar

4. **Documenta√ß√£o:**
   - Manter este documento atualizado com incidentes
   - Documentar processo de rollback completo

## üìù Notas Adicionais

- O script `deploy-zero-downtime.sh` deveria ter garantido que ambas vers√µes estavam rodando antes de alternar
- A configura√ß√£o do `kanban-buzz` (para testes locais) estava correta
- O problema estava apenas na configura√ß√£o do dom√≠nio p√∫blico (`agilizeflow.com.br`)

## üîó Arquivos Relacionados

- `/etc/nginx/sites-enabled/agilizeflow.com.br` - Configura√ß√£o do dom√≠nio p√∫blico
- `/etc/nginx/sites-enabled/kanban-buzz` - Configura√ß√£o para testes locais
- `scripts/deploy-zero-downtime.sh` - Script de deploy
- `nginx-reverse-proxy.conf` - Template de configura√ß√£o

---

**Resolvido por:** Cursor AI  
**Data de resolu√ß√£o:** 19/12/2025 00:05 UTC



